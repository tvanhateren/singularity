Bootstrap: shub
From: tikk3r/lofar-grid-hpccloud:lofar
# Bootstrap: localimage
# From: lofar-grid-hpccloud_lofar.sif

%help
	This Singularity image contains an install of ddf-pipeline.

	Runtime example:
	$ singularity exec ddf-pipeline.simg tier1.cfg

	If your data is on /var/scratch/$USER/, you can bind the directory into the container at for example /data using the -B/--bind option
	$ singularity exec -B /var/scratch/$USER/:/data ddf-pipeline.simg tier1.cfg

%setup
	cp -r scripts ${SINGULARITY_ROOTFS}/opt/lofar/

%environment
	source /opt/lofar/scripts/env.sh

%post
	# Set-up environment
	source /opt/lofar/scripts/env-vars.sh

	yum install -y Cython fpack

	cd ${INSTALLDIR}

	# Install ddf-pipeline
	git clone --single-branch -b DR1 https://github.com/mhardcastle/ddf-pipeline.git

	# moving init.sh because install.sh also writes to that same file
	mv init.sh scripts/init.lofar.sh
	bash ddf-pipeline/scripts/install.sh
	mv init.sh scripts/init.ddf-pipeline.sh

	# Python dependencies
	source ${INSTALLDIR}/scripts/env-py-path.sh

	pip install -r DDFacet/requirements.txt

	# Requirements in docs/manual.md
	pip install astropy-healpix emcee pyrap pyregion reproject

	# Requirements not mentioned
	pip install prettytable

	# Catalogs
	mkdir DDFCatalogs
	wget -P DDFCatalogs http://tgssadr.strw.leidenuniv.nl/catalogs/TGSSADR1_7sigma_catalog.fits
	wget -P DDFCatalogs https://www.extragalactic.info/bootstrap/VLSS.fits
	wget -P DDFCatalogs https://www.extragalactic.info/bootstrap/wenss.fits
	# wget -P DDFCatalogs https://www.extragalactic.info/bootstrap/NVSS.fits

	echo "$(tput setaf 2)> Done installing: $(tput setaf 7)"
	ls -lah ${INSTALLDIR}

%runscript
	exec bash "$@"
